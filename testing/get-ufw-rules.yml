---
- hosts: all
  become: true
  tasks:
    - name: Fetch IP data from URL
      uri:
        url: https://stats.osbornetech.support/ansible/ufw/ufw_rules.json
        method: GET
        return_content: yes
      register: ip_data
      ignore_errors: true
      check_mode: no

    - name: Parse JSON data
      set_fact:
        ip_list: "{{ ip_data.content | from_json }}"
      when: ip_data.content is defined and ip_data.status == 200
      ignore_errors: true

    - name: Check if JSON parsing failed or URL fetch failed
      fail:
        msg: "Failed to parse JSON data or fetch URL. Check 'ip_data' for details."
      when: ip_list is undefined or ip_data.failed or ip_data.status != 200

    - name: Add UFW rules for allowed IPs
      ufw:
        rule: allow
        src: "{{ item.port }}"
        comment: "{{ item.comment | default('Managed by Ansible') }}"
      loop: "{{ ip_list }}"
      when: ip_list is defined

    - name: Ensure IP addresses are in the correct format for ufw.rules
      set_fact:
        ufw_rules_entries: >-
          {{ ip_list | map(attribute='port') | list | map('regex_replace', '^(.*)$', '-A ufw-user-input -s \\1 -j ACCEPT') | list }}

    - name: Update ufw.rules file (remove outdated entries)
      blockinfile:
        path: /etc/ufw/user.rules
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        block: |
          {% for entry in ufw_rules_entries %}
          {{ entry }}
          {% endfor %}
      become: true
      register: ufw_rules_update

    - name: Reload UFW if rules were updated
      ufw:
        state: reloaded
      when: ufw_rules_update.changed
